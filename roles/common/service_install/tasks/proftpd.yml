- name: Proftpd 설치
  block:
    - name: 설치파일 rsync
      shell: | 
        rsync -a {{ SETUP }}::set/app/proftpd-1.3.7a.tar.gz {{ SRC }}/

    - name: 설치파일 압축해제
      unarchive:
        src: "{{ SRC }}/proftpd-1.3.7a.tar.gz"
        dest: "{{ SRC }}/"
        remote_src: yes

    - name: PAM 파일 rsync
      shell: |
        rsync -a {{ SETUP }}::set/config/pam_proftpd /etc/pam.d/proftpd

    - name: proftpd 설치(configure)
      shell: >
        ./configure -prefix=/usr/local/proftpd
                    --sysconfdir=/etc/proftpd
                    --mandir=/usr/share/man
                    --enable-dso --enable-nls
                    --enable-openssl --enable-authshadow
                    --enable-shadow --enable-ctrls
                    --with-modules=mod_tls

      args:
        chdir: "/usr/local/src/proftpd-1.3.7a"
      register: configure_result
 
    - name: proftpd 설치 (make -> make install)
      shell: make && make install
      args:
        chdir: "/usr/local/src/proftpd-1.3.7a"
      when: configure_result.rc == 0

    - name: proftpd 설정파일 rsync
      shell: |
        rsync -a {{ SETUP }}::set/config/proftpd/ /etc/proftpd/

    - name: proftpd 실행 스크립트 rsync
      shell: |
        rsync -a {{ SETUP }}::set/config/centos7/init.proftpd /etc/init.d/proftpd

    - name: 쉘 추가
      lineinfile:
        path: /etc/shells
        line: "/sbin/nologin"
        state: present

    - name: rc3.d 실행 스크립트 심볼릭
      file: 
        src: "/etc/init.d/proftpd"
        dest: "/etc/rc3.d/S85proftpd"
        state: link

    - name: ftp 로그 디렉터리 생성
      file: 
        path: /web_log/ftp_log
        state: directory
        owner: root
        group: root

    - name: ftpusers 파일 생성
      file: 
        path: /etc/ftpusers
        state: touch
        owner: root
        group: root

    - name: ftpusers root 추가
      lineinfile:
        path: /etc/ftpusers
        line: "root"

    - name: proftpd 시작
      service:
        name: proftpd
        state: started
        enabled: yes
