---
- name : FTP 권한변경(서버이전) playbook
  hosts: localhost
  user: zlxpf
  become: true
  become_method: sudo 


  vars:
    new_web_ip: 121.78.197.53
    new_db_ip: 121.78.197.72
  
  vars_prompt:
    - name: old_web_ip
      prompt: "구 웹서버 IP를 입력해주세요."
      private: no 
    - name: domain_name
      prompt: "임시도메인을 입력해주세요. (ex. test.firstmall.kr)"
      private: no
    - name: old_db_ip
      prompt: "구 DB서버 IP를 입력해주세요."
      private: no
    - name: db_name
      prompt: "DB 이름을 입력해주세요."
      private: no


#공통변수 설정(하위 roles에서 사용)
  tasks:
    - name: 1.homedir_name
      set_fact:
        homedir_name: "{{ domain_name | replace('.', '_') | replace('-', '_') }}"
    - name: homedir_name debug
      debug: 
        var: homedir_name    


    - name: 2.account_name
      shell: |
        cat /etc/passwd | grep {{ domain_name }}/data | awk -F ':' '{print $1}' 
      register: account_name
      delegate_to: "{{ old_web_ip }}"
    - name: account_name debug
      debug:
        var: account_name.stdout
  
    
    - name: 3.conf_path
      shell: |
        if [ -e "/etc/httpd/conf/vhost/{{ domain_name }}.conf" ]; then
          echo "/etc/httpd/conf/"
        else
          echo "/usr/local/apache/conf/"
        fi
      register: conf_path
      delegate_to: "{{ old_web_ip }}"
    - name: conf_path debug
      debug:
        var: conf_path.stdout


    - name: 4.ssl_info
      shell: |
        count=$(grep -w ServerName {{ conf_path.stdout }}/vhost/{{ domain_name }}.conf | grep -v "firstmall.kr" | wc -l)
        ssl_domain=$(grep -w ServerName {{ conf_path.stdout }}/vhost/{{ domain_name }}.conf | grep -v "firstmall.kr" | awk '{print $2}')
        ssl_account=$(ls /etc/letsencrypt/accounts/acme-v02.api.letsencrypt.org/directory)
        echo "$count"
        echo "$ssl_domain"
        echo "$ssl_account"

      register: ssl_info
      delegate_to: "{{ new_web_ip }}"
     
    - name: SSL debug
      debug: 
        var: ssl_info.stdout_lines

    
    - name: 5.DB root password
      include_vars:
        file: /etc/ansible/roles/db/vars/password.yml


#roles 파일 (순차적으로 실행)
    - include_role: 
        name: web
        tasks_from: servermove_1.yml
    - include_role: 
        name: web
        tasks_from: servermove_2.yml
    - include_role: 
        name: db
        tasks_from: servermove.yml
